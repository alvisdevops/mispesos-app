name: Deploy to alvis-server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Verify data directories exist
        run: |
          # Verificar que /var/lib/mispesos exista
          if [ ! -d "/var/lib/mispesos" ]; then
            echo "‚ùå ERROR: /var/lib/mispesos no existe"
            echo ""
            echo "üí° Debes crear el directorio en el servidor"
            exit 1
          fi
          echo "‚úÖ Directorios de datos verificados: /var/lib/mispesos"

      - name: Create .env file from secrets
        run: |
          # Contar variables v√°lidas del .env original (excluye comentarios y l√≠neas vac√≠as)
          ORIGINAL_COUNT=$(grep -v '^#' .env | grep -v '^$' | grep -c '=' || echo 0)
          echo "üìä El .env original tiene $ORIGINAL_COUNT variables"

          # Generar .env con valores de secrets
          cat > .env << EOF
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
          DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}
          OLLAMA_MODEL=llama3.2:3b
          FASTAPI_PORT=${{ secrets.FASTAPI_PORT }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          DATA_PATH=/var/lib/mispesos
          EOF

          # Contar variables del .env generado
          GENERATED_COUNT=$(grep -v '^#' .env | grep -v '^$' | grep -c '=' || echo 0)
          echo "üìä El .env generado tiene $GENERATED_COUNT variables"

          # Validar integridad: ambos archivos deben tener la misma cantidad de variables
          if [ "$GENERATED_COUNT" -ne "$ORIGINAL_COUNT" ]; then
            echo "‚ùå ERROR: Las cantidades de variables no coinciden!"
            echo "   Esperadas: $ORIGINAL_COUNT variables (del .env del repo)"
            echo "   Generadas: $GENERATED_COUNT variables (en el workflow)"
            echo ""
            echo "üí° Revisa el archivo .env y los secretos del repositorio deben tener la misma cantidad de variables"
            exit 1
          fi

          echo "‚úÖ Archivo .env creado y validado ($GENERATED_COUNT/$ORIGINAL_COUNT variables)"

      - name: Deploy with Docker Compose
        run: |
          echo "üöÄ Starting deployment..."
          docker compose up -d
          echo ""
          echo "üìä Container Status:"
          docker compose ps
          echo ""
          echo "‚úÖ Deployment completed successfully"

      - name: Setup Ollama AI model
        run: |
          echo "ü§ñ Checking Ollama AI model..."
          # Wait for Ollama to be ready
          for i in {1..30}; do
            if docker compose exec -T ollama ollama list > /dev/null 2>&1; then
              echo "‚úÖ Ollama is ready"
              break
            fi
            echo "‚è≥ Waiting for Ollama... ($i/30)"
            sleep 5
          done

          # Check if model exists
          MODEL=$(grep OLLAMA_MODEL .env | cut -d '=' -f2)
          echo "üì¶ Checking for model: $MODEL"

          if docker compose exec -T ollama ollama list | grep -q "$MODEL"; then
            echo "‚úÖ Model $MODEL already exists, skipping download"
          else
            echo "üì• Downloading model $MODEL (this may take several minutes on first run)..."
            docker compose exec -T ollama ollama pull "$MODEL"
            echo "‚úÖ Model $MODEL downloaded successfully"
          fi
