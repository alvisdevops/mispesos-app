name: Deploy to alvis-server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Verify data directories exist
        run: |
          # Verificar que /var/lib/mispesos exista
          if [ ! -d "/var/lib/mispesos" ]; then
            echo "âŒ ERROR: /var/lib/mispesos no existe"
            echo ""
            echo "ðŸ’¡ Debes crear el directorio en el servidor"
            exit 1
          fi
          echo "âœ… Directorios de datos verificados: /var/lib/mispesos"

      - name: Create .env file from secrets
        run: |
          # Contar variables vÃ¡lidas del .env original (excluye comentarios y lÃ­neas vacÃ­as)
          ORIGINAL_COUNT=$(grep -v '^#' .env | grep -v '^$' | grep -c '=' || echo 0)
          echo "ðŸ“Š El .env original tiene $ORIGINAL_COUNT variables"

          # Extraer OLLAMA_MODEL del .env del repositorio (Ãºnica fuente de verdad)
          OLLAMA_MODEL=$(grep OLLAMA_MODEL .env | cut -d '=' -f2)
          echo "ðŸ¤– Using Ollama model from repo: $OLLAMA_MODEL"

          # Generar .env con valores de secrets
          cat > .env << EOF
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
          DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}
          FASTAPI_PORT=${{ secrets.FASTAPI_PORT }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          DATA_PATH=/var/lib/mispesos
          EOF

          # Contar variables del .env generado
          GENERATED_COUNT=$(grep -v '^#' .env | grep -v '^$' | grep -c '=' || echo 0)
          echo "ðŸ“Š El .env generado tiene $GENERATED_COUNT variables"

          # Validar integridad: ambos archivos deben tener la misma cantidad de variables
          if [ "$GENERATED_COUNT" -ne "$ORIGINAL_COUNT" ]; then
            echo "âŒ ERROR: Las cantidades de variables no coinciden!"
            echo "   Esperadas: $ORIGINAL_COUNT variables (del .env del repo)"
            echo "   Generadas: $GENERATED_COUNT variables (en el workflow)"
            echo ""
            echo "ðŸ’¡ Revisa el archivo .env y los secretos del repositorio deben tener la misma cantidad de variables"
            exit 1
          fi

          echo "âœ… Archivo .env creado y validado ($GENERATED_COUNT/$ORIGINAL_COUNT variables)"

      - name: Deploy with Docker Compose
        run: |
          echo "ðŸš€ Starting deployment..."
          docker compose up -d --build
          echo ""
          echo "ðŸ“Š Container Status:"
          docker compose ps
          echo ""
          echo "âœ… Deployment completed successfully"